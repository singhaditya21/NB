<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Search Command Center</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --blue: #2563EB;
      --blue-light: #DBEAFE;
      --green: #059669;
      --green-light: #D1FAE5;
      --amber: #D97706;
      --amber-light: #FEF3C7;
      --red: #DC2626;
      --red-light: #FEE2E2;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-500: #6B7280;
      --gray-700: #374151;
      --gray-900: #111827;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
    }

    /* Header */
    header {
      background: #fff;
      border-bottom: 1px solid var(--gray-200);
      padding: 14px 28px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 17px;
      font-weight: 700;
      color: var(--gray-900);
    }

    header h1 span {
      color: var(--blue);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-dot.on {
      background: var(--green);
      box-shadow: 0 0 6px rgba(5, 150, 105, 0.4);
    }

    .status-dot.off {
      background: var(--red);
    }

    .status-text {
      font-size: 12px;
      color: var(--gray-500);
    }

    /* Date Filter */
    .date-filter {
      display: flex;
      gap: 4px;
      background: var(--gray-100);
      border-radius: 8px;
      padding: 3px;
    }

    .date-btn {
      padding: 6px 14px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      background: transparent;
      color: var(--gray-500);
      transition: all 0.2s;
    }

    .date-btn.active {
      background: #fff;
      color: var(--blue);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .date-btn:hover {
      color: var(--blue);
    }

    /* Container */
    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 20px 28px;
    }

    /* KPI Grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 14px;
      margin-bottom: 20px;
    }

    @media (max-width: 900px) {
      .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .kpi {
      background: #fff;
      border: 1px solid var(--gray-200);
      border-radius: 10px;
      padding: 18px 20px;
    }

    .kpi-label {
      font-size: 11px;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }

    .kpi-value {
      font-size: 30px;
      font-weight: 700;
      margin: 4px 0 2px;
      font-variant-numeric: tabular-nums;
    }

    .kpi-sub {
      font-size: 11px;
      color: var(--gray-500);
    }

    .kpi-blue .kpi-value {
      color: var(--blue);
    }

    .kpi-green .kpi-value {
      color: var(--green);
    }

    .kpi-amber .kpi-value {
      color: var(--amber);
    }

    /* Charts Row */
    .charts-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-bottom: 20px;
    }

    @media (max-width: 900px) {
      .charts-row {
        grid-template-columns: 1fr;
      }
    }

    .chart-card {
      background: #fff;
      border: 1px solid var(--gray-200);
      border-radius: 10px;
      padding: 18px;
    }

    .chart-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 12px;
    }

    .chart-canvas {
      width: 100%;
      height: 200px;
    }

    /* Pipeline Funnel */
    .funnel {
      background: #fff;
      border: 1px solid var(--gray-200);
      border-radius: 10px;
      padding: 18px 20px;
      margin-bottom: 20px;
    }

    .funnel-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 14px;
    }

    .funnel-bar {
      display: flex;
      align-items: center;
      gap: 0;
      height: 42px;
      border-radius: 8px;
      overflow: hidden;
    }

    .funnel-seg {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      height: 100%;
      transition: all 0.3s;
      min-width: 60px;
    }

    .funnel-seg .f-count {
      font-size: 16px;
      font-weight: 700;
      color: #fff;
    }

    .funnel-seg .f-label {
      font-size: 9px;
      color: rgba(255, 255, 255, 0.85);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .funnel-legend {
      display: flex;
      gap: 20px;
      margin-top: 10px;
      font-size: 11px;
      color: var(--gray-500);
    }

    .funnel-legend span {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .funnel-legend .dot {
      width: 10px;
      height: 10px;
      border-radius: 3px;
      display: inline-block;
    }

    /* Table */
    .table-card {
      background: #fff;
      border: 1px solid var(--gray-200);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .table-header {
      padding: 14px 18px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .table-header h3 {
      font-size: 13px;
      font-weight: 600;
    }

    .table-search {
      padding: 6px 12px;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      font-size: 12px;
      width: 200px;
      outline: none;
    }

    .table-search:focus {
      border-color: var(--blue);
    }

    .table-wrap {
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th {
      text-align: left;
      padding: 8px 12px;
      font-size: 10px;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
      background: var(--gray-50);
      position: sticky;
      top: 0;
      cursor: pointer;
      user-select: none;
      border-bottom: 1px solid var(--gray-200);
    }

    th:hover {
      color: var(--blue);
    }

    td {
      padding: 8px 12px;
      border-bottom: 1px solid var(--gray-100);
      vertical-align: middle;
    }

    tr:hover td {
      background: var(--gray-50);
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 600;
    }

    .badge-green {
      background: var(--green-light);
      color: var(--green);
    }

    .badge-blue {
      background: var(--blue-light);
      color: var(--blue);
    }

    .badge-amber {
      background: var(--amber-light);
      color: var(--amber);
    }

    .badge-red {
      background: var(--red-light);
      color: var(--red);
    }

    a.job-link {
      color: var(--blue);
      text-decoration: none;
      font-weight: 500;
    }

    a.job-link:hover {
      text-decoration: underline;
    }

    /* Insights + Contacts */
    .bottom-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-bottom: 20px;
    }

    @media (max-width: 900px) {
      .bottom-grid {
        grid-template-columns: 1fr;
      }
    }

    .insight-card {
      background: #fff;
      border: 1px solid var(--gray-200);
      border-radius: 10px;
      padding: 18px;
    }

    .insight-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 12px;
    }

    .insight-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid var(--gray-100);
      font-size: 12px;
    }

    .insight-row:last-child {
      border: none;
    }

    .insight-label {
      color: var(--gray-500);
    }

    .insight-val {
      font-weight: 600;
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      background: var(--blue-light);
      color: var(--blue);
      border-radius: 4px;
      font-size: 10px;
      margin: 2px;
      font-weight: 500;
    }

    /* Controls */
    .controls {
      background: #fff;
      border: 1px solid var(--gray-200);
      border-radius: 10px;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .ctrl-btn {
      padding: 7px 16px;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      background: #fff;
    }

    .ctrl-btn:hover {
      border-color: var(--blue);
      color: var(--blue);
    }

    .ctrl-btn.danger {
      border-color: var(--red);
      color: var(--red);
    }

    .ctrl-btn.danger:hover {
      background: var(--red-light);
    }

    /* Log panel */
    .log-panel {
      background: #fff;
      border: 1px solid var(--gray-200);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .log-header {
      padding: 10px 18px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      font-weight: 600;
    }

    .log-body {
      max-height: 250px;
      overflow-y: auto;
      padding: 8px 14px;
      font-family: 'Cascadia Code', 'Fira Code', monospace;
      font-size: 11px;
      line-height: 1.7;
      background: var(--gray-50);
    }

    .log-line {
      padding: 1px 6px;
      border-radius: 3px;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .log-line:hover {
      background: var(--gray-200);
    }

    .l-info {
      color: var(--gray-500);
    }

    .l-warn {
      color: var(--amber);
    }

    .l-error {
      color: var(--red);
      font-weight: 500;
    }

    .log-count {
      font-weight: 400;
      color: var(--gray-500);
      font-size: 11px;
    }

    /* Gemini meter */
    .meter-bg {
      width: 100%;
      height: 8px;
      background: var(--gray-200);
      border-radius: 4px;
      margin-top: 6px;
    }

    .meter-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s;
    }
  </style>
</head>

<body>
  <header>
    <h1><span>●</span> Job Search <span>Command Center</span></h1>
    <div class="header-right">
      <span class="status-dot on" id="ws-dot"></span>
      <span class="status-text" id="ws-status">Connecting...</span>
      <div class="date-filter">
        <button class="date-btn active" data-range="today">Today</button>
        <button class="date-btn" data-range="week">This Week</button>
        <button class="date-btn" data-range="all">All Time</button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- KPI Row 1 -->
    <div class="kpi-grid" id="kpi-row">
      <div class="kpi kpi-blue">
        <div class="kpi-label">Applications</div>
        <div class="kpi-value" id="k-applied">—</div>
        <div class="kpi-sub" id="k-applied-sub">in selected range</div>
      </div>
      <div class="kpi kpi-green">
        <div class="kpi-label">Avg Match Score</div>
        <div class="kpi-value" id="k-score">—</div>
        <div class="kpi-sub">across applied jobs</div>
      </div>
      <div class="kpi kpi-blue">
        <div class="kpi-label">Contacts Found</div>
        <div class="kpi-value" id="k-contacts">—</div>
        <div class="kpi-sub">emails + LinkedIn</div>
      </div>
      <div class="kpi kpi-amber">
        <div class="kpi-label">Recruiter Messages</div>
        <div class="kpi-value" id="k-messages">—</div>
        <div class="kpi-sub">auto-sent via Naukri</div>
      </div>
    </div>
    <!-- KPI Row 2 -->
    <div class="kpi-grid">
      <div class="kpi">
        <div class="kpi-label">Cover Letters</div>
        <div class="kpi-value" id="k-covers" style="color:var(--blue)">—</div>
        <div class="kpi-sub">for 70+ score jobs</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Total All-Time</div>
        <div class="kpi-value" id="k-total" style="color:var(--gray-700)">—</div>
        <div class="kpi-sub">lifetime applications</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Profile Skills</div>
        <div class="kpi-value" id="k-skills" style="color:var(--green)">—</div>
        <div class="kpi-sub">inc. AI-learned</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Gemini Free Tier</div>
        <div class="kpi-value" id="k-gemini" style="color:var(--gray-700); font-size:20px;">—</div>
        <div class="meter-bg">
          <div class="meter-fill" id="gemini-meter" style="width:0%; background:var(--green);"></div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts-row">
      <div class="chart-card">
        <div class="chart-title">Application Volume</div>
        <canvas id="volumeChart" class="chart-canvas"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-title">Score Distribution</div>
        <canvas id="scoreChart" class="chart-canvas"></canvas>
      </div>
    </div>

    <!-- Pipeline Funnel -->
    <div class="funnel">
      <div class="funnel-title">Pipeline Funnel</div>
      <div class="funnel-bar" id="funnel-bar"></div>
      <div class="funnel-legend">
        <span><span class="dot" style="background:var(--blue)"></span> Applied</span>
        <span><span class="dot" style="background:#7C3AED"></span> Messaged</span>
        <span><span class="dot" style="background:var(--amber)"></span> Interview</span>
        <span><span class="dot" style="background:var(--green)"></span> Offer</span>
      </div>
    </div>

    <!-- Applications Table -->
    <div class="table-card">
      <div class="table-header">
        <h3>Applications</h3>
        <input type="text" class="table-search" id="job-search" placeholder="Search company or role...">
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th data-sort="appliedAt">Time</th>
              <th data-sort="company">Company</th>
              <th data-sort="title">Role</th>
              <th data-sort="matchScore">Score</th>
              <th>Recruiter Msg</th>
              <th>Contact</th>
              <th>Status</th>
              <th>Link</th>
            </tr>
          </thead>
          <tbody id="jobs-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Insights + Contacts -->
    <div class="bottom-grid">
      <div class="insight-card">
        <div class="insight-title">Top Insights</div>
        <div id="insights-body"></div>
      </div>
      <div class="insight-card">
        <div class="insight-title">Extracted Contacts</div>
        <div style="max-height:280px; overflow-y:auto;">
          <table style="font-size:11px;">
            <thead>
              <tr>
                <th>Company</th>
                <th>Recruiter</th>
                <th>Email</th>
                <th>LinkedIn</th>
              </tr>
            </thead>
            <tbody id="contacts-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Bot Controls -->
    <div class="controls">
      <button class="ctrl-btn" onclick="botControl('pause')">⏸ Pause</button>
      <button class="ctrl-btn" onclick="botControl('resume')">▶ Resume</button>
      <button class="ctrl-btn danger" onclick="botControl('stop')">⏹ Emergency Stop</button>
      <span style="margin-left:auto; font-size:11px; color:var(--gray-500);">
        Search Roles: <span id="roles-tags"></span>
      </span>
    </div>

    <!-- Live Logs -->
    <div class="log-panel">
      <div class="log-header">Live Agent Logs <span class="log-count" id="log-count">0 lines</span></div>
      <div class="log-body" id="log-body"></div>
    </div>
  </div>

  <script>
    let currentRange = 'today';
    let logCount = 0;
    let volumeChart, scoreChart;
    let allJobs = [];
    let sortCol = 'appliedAt', sortDir = -1;

    // Date filter
    document.querySelectorAll('.date-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentRange = btn.dataset.range;
        loadAll();
      });
    });

    // WebSocket
    function connectWS() {
      const ws = new WebSocket(`ws://${location.host}`);
      ws.onopen = () => { document.getElementById('ws-dot').className = 'status-dot on'; document.getElementById('ws-status').textContent = 'Live'; };
      ws.onclose = () => { document.getElementById('ws-dot').className = 'status-dot off'; document.getElementById('ws-status').textContent = 'Disconnected'; setTimeout(connectWS, 3000); };
      ws.onmessage = (e) => { const d = JSON.parse(e.data); if (d.type === 'log') addLog(d); };
    }

    function addLog(entry) {
      const el = document.getElementById('log-body');
      const div = document.createElement('div');
      const cls = entry.level === 'error' ? 'l-error' : entry.level === 'warn' ? 'l-warn' : 'l-info';
      div.className = `log-line ${cls}`;
      const ts = entry.timestamp ? entry.timestamp.split(' ')[1] || '' : '';
      div.textContent = `${ts} [${entry.level}] ${entry.message}`;
      el.appendChild(div);
      logCount++;
      document.getElementById('log-count').textContent = `${logCount} lines`;
      while (el.children.length > 500) el.removeChild(el.firstChild);
      el.scrollTop = el.scrollHeight;
    }

    // Load all data
    async function loadAll() {
      try {
        const [statsRes, jobsRes, contactsRes] = await Promise.all([
          fetch(`/api/stats?range=${currentRange}`),
          fetch(`/api/jobs?range=${currentRange}`),
          fetch('/api/contacts')
        ]);
        const stats = await statsRes.json();
        const jobs = await jobsRes.json();
        const contacts = await contactsRes.json();
        renderKPIs(stats);
        renderCharts(stats);
        renderFunnel(stats.pipeline);
        renderInsights(stats);
        allJobs = jobs;
        renderJobs(jobs);
        renderContacts(contacts);
      } catch (err) { console.error('Load failed:', err); }
    }

    function renderKPIs(s) {
      document.getElementById('k-applied').textContent = s.appliedInRange;
      document.getElementById('k-applied-sub').textContent = `${currentRange === 'today' ? 'today' : currentRange === 'week' ? 'this week' : 'all time'}`;
      document.getElementById('k-score').textContent = s.avgScore || '—';
      document.getElementById('k-contacts').textContent = s.contactsFound;
      document.getElementById('k-messages').textContent = s.messagesSent;
      document.getElementById('k-covers').textContent = s.coverLetters;
      document.getElementById('k-total').textContent = s.appliedTotal;
      document.getElementById('k-skills').textContent = s.profileSkills;
      const pct = Math.round((s.geminiUsed / s.geminiLimit) * 100);
      document.getElementById('k-gemini').textContent = `${s.geminiUsed} / ${s.geminiLimit}`;
      const meter = document.getElementById('gemini-meter');
      meter.style.width = `${pct}%`;
      meter.style.background = pct > 80 ? 'var(--red)' : pct > 50 ? 'var(--amber)' : 'var(--green)';
      // Roles
      document.getElementById('roles-tags').innerHTML = (s.targetRoles || []).slice(0, 6).map(r => `<span class="tag">${r}</span>`).join(' ');
    }

    function renderCharts(s) {
      // Volume chart
      const vLabels = Object.keys(s.volumeMap).sort();
      const vData = vLabels.map(k => s.volumeMap[k]);
      if (volumeChart) volumeChart.destroy();
      volumeChart = new Chart(document.getElementById('volumeChart'), {
        type: 'bar',
        data: { labels: vLabels, datasets: [{ label: 'Applications', data: vData, backgroundColor: '#2563EB', borderRadius: 4, barPercentage: 0.6 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 5, font: { size: 10 } } }, x: { ticks: { font: { size: 10 } } } } }
      });

      // Score chart
      const sLabels = Object.keys(s.scoreDist);
      const sData = sLabels.map(k => s.scoreDist[k]);
      const sColors = ['#DC2626', '#D97706', '#2563EB', '#059669', '#059669'];
      if (scoreChart) scoreChart.destroy();
      scoreChart = new Chart(document.getElementById('scoreChart'), {
        type: 'bar',
        data: { labels: sLabels, datasets: [{ label: 'Jobs', data: sData, backgroundColor: sColors, borderRadius: 4, barPercentage: 0.7 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 10, font: { size: 10 } } }, x: { ticks: { font: { size: 10 } } } } }
      });
    }

    function renderFunnel(p) {
      const total = Math.max(p.applied, 1);
      const bar = document.getElementById('funnel-bar');
      const segments = [
        { label: 'Applied', count: p.applied, color: 'var(--blue)' },
        { label: 'Messaged', count: p.messaged, color: '#7C3AED' },
        { label: 'Interview', count: p.interview, color: 'var(--amber)' },
        { label: 'Offer', count: p.offer, color: 'var(--green)' },
      ];
      bar.innerHTML = segments.map(s => {
        const w = Math.max((s.count / total) * 100, s.count > 0 ? 8 : 4);
        return `<div class="funnel-seg" style="width:${w}%; background:${s.color}"><span class="f-count">${s.count}</span><span class="f-label">${s.label}</span></div>`;
      }).join('');
    }

    function renderJobs(jobs) {
      const search = (document.getElementById('job-search').value || '').toLowerCase();
      let filtered = jobs;
      if (search) filtered = jobs.filter(j => ((j.company || '') + ' ' + (j.title || '')).toLowerCase().includes(search));
      // Sort
      filtered.sort((a, b) => {
        let va = a[sortCol] || '', vb = b[sortCol] || '';
        if (typeof va === 'number') return (va - vb) * sortDir;
        return String(va).localeCompare(String(vb)) * sortDir;
      });
      const tbody = document.getElementById('jobs-tbody');
      tbody.innerHTML = filtered.slice(0, 100).map(j => {
        const time = j.appliedAt ? new Date(j.appliedAt).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }) : '—';
        const sc = j.matchScore || 0;
        const bclass = sc >= 70 ? 'badge-green' : sc >= 50 ? 'badge-blue' : sc >= 40 ? 'badge-amber' : 'badge-red';
        const msg = j.recruiterMessageSent ? '<span class="badge badge-green">Sent</span>' : '<span style="color:var(--gray-300)">—</span>';
        const contact = j.recruiterName ? j.recruiterName : '<span style="color:var(--gray-300)">—</span>';
        const status = `<span class="badge ${j.status === 'interview' ? 'badge-green' : j.status === 'offer' ? 'badge-green' : 'badge-blue'}">${j.status || 'applied'}</span>`;
        const link = j.url ? `<a class="job-link" href="${j.url}" target="_blank">Open →</a>` : '—';
        return `<tr><td>${time}</td><td>${j.company || '—'}</td><td style="max-width:200px">${j.title || '—'}</td><td><span class="badge ${bclass}">${sc}</span></td><td>${msg}</td><td>${contact}</td><td>${status}</td><td>${link}</td></tr>`;
      }).join('');
    }

    function renderInsights(s) {
      const body = document.getElementById('insights-body');
      let html = '';
      // Top companies
      if (s.topCompanies && s.topCompanies.length > 0) {
        html += `<div class="insight-row"><span class="insight-label">Most Applied Company</span><span class="insight-val">${s.topCompanies[0].name} (${s.topCompanies[0].count})</span></div>`;
      }
      // Top roles
      if (s.topRoles && s.topRoles.length > 0) {
        html += `<div class="insight-row"><span class="insight-label">Top Role Match</span><span class="insight-val">${s.topRoles[0].name} (${s.topRoles[0].count})</span></div>`;
      }
      html += `<div class="insight-row"><span class="insight-label">Avg Match Score</span><span class="insight-val">${s.avgScore}%</span></div>`;
      html += `<div class="insight-row"><span class="insight-label">Premium Pipeline (70+)</span><span class="insight-val">${s.coverLetters} jobs</span></div>`;
      // Skills learned
      if (s.skillsLearned && s.skillsLearned.length > 0) {
        html += `<div class="insight-row"><span class="insight-label">AI-Learned Skills</span><span class="insight-val">${s.skillsLearned.slice(-5).join(', ')}</span></div>`;
      }
      // Top companies list
      if (s.topCompanies && s.topCompanies.length > 1) {
        html += '<div style="margin-top:10px; font-size:11px; color:var(--gray-500);">Top Companies</div>';
        s.topCompanies.forEach(c => {
          html += `<div class="insight-row"><span class="insight-label">${c.name}</span><span class="insight-val">${c.count}</span></div>`;
        });
      }
      body.innerHTML = html;
    }

    function renderContacts(contacts) {
      const tbody = document.getElementById('contacts-tbody');
      tbody.innerHTML = contacts.slice(0, 30).map(c => {
        const email = (c.emails || []).join(', ') || '<span style="color:var(--gray-300)">—</span>';
        const li = (c.linkedinUrls || []).map(u => `<a href="${u}" target="_blank" class="job-link">${(u.split('/in/')[1] || '').replace(/\/$/, '') || 'profile'}</a>`).join(', ') || '<span style="color:var(--gray-300)">—</span>';
        return `<tr><td>${c.company || '—'}</td><td>${c.recruiterName || '—'}</td><td>${email}</td><td>${li}</td></tr>`;
      }).join('');
    }

    // Sort
    document.querySelectorAll('th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const col = th.dataset.sort;
        if (sortCol === col) sortDir *= -1; else { sortCol = col; sortDir = -1; }
        renderJobs(allJobs);
      });
    });

    // Search
    document.getElementById('job-search').addEventListener('input', () => renderJobs(allJobs));

    // Bot control
    async function botControl(action) {
      if (action === 'stop' && !confirm('Emergency stop? You will need to restart the container.')) return;
      try {
        const r = await fetch(`/api/control?action=${action}`);
        const d = await r.json();
        if (d.ok) alert(`Action "${action}" executed.`);
      } catch { alert('Failed to execute action.'); }
    }

    // Init
    connectWS();
    loadAll();
    setInterval(loadAll, 8000);
  </script>
</body>

</html>