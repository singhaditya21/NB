<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Search Command Center</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: #F8FAFC;
      color: #1E293B;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Header */
    .hdr {
      background: #fff;
      border-bottom: 1px solid #E2E8F0;
      padding: 12px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .hdr-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .hdr h1 {
      font-size: 20px;
      font-weight: 700;
      color: #0F172A;
    }

    .hdr h1 b {
      color: #2563EB;
    }

    .live-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      background: #F0FDF4;
      border: 1px solid #BBF7D0;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: #16A34A;
    }

    .live-badge .pulse {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #16A34A;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: .4
      }
    }

    .live-badge.off {
      background: #FEF2F2;
      border-color: #FECACA;
      color: #DC2626;
    }

    .live-badge.off .pulse {
      background: #DC2626;
      animation: none;
    }

    .hdr-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .date-pills {
      display: flex;
      gap: 4px;
      background: #F1F5F9;
      border-radius: 8px;
      padding: 3px;
    }

    .dp {
      padding: 6px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: transparent;
      color: #64748B;
      transition: .15s;
    }

    .dp.on {
      background: #fff;
      color: #2563EB;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .08);
      font-weight: 600;
    }

    .dp:hover {
      color: #2563EB;
    }

    /* Tab Nav */
    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid #E2E8F0;
      flex-shrink: 0;
      background: #fff;
      padding: 0 32px;
    }

    .tab {
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      color: #64748B;
      transition: .15s;
    }

    .tab:hover {
      color: #2563EB;
    }

    .tab.on {
      color: #2563EB;
      border-bottom-color: #2563EB;
      font-weight: 600;
    }

    .tab .cnt {
      font-size: 11px;
      background: #DBEAFE;
      color: #2563EB;
      padding: 2px 7px;
      border-radius: 10px;
      margin-left: 6px;
      font-weight: 700;
    }

    /* Main area */
    .main {
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    .pane {
      position: absolute;
      inset: 0;
      display: none;
      overflow-y: auto;
      padding: 24px 32px;
    }

    .pane.on {
      display: block;
    }

    /* ─── OVERVIEW TAB ─── */
    /* KPI Row */
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .kpi-card {
      background: #fff;
      border-radius: 12px;
      padding: 20px 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .04);
      border: 1px solid #F1F5F9;
    }

    .kpi-card .label {
      font-size: 12px;
      font-weight: 500;
      color: #94A3B8;
      text-transform: uppercase;
      letter-spacing: .5px;
      margin-bottom: 6px;
    }

    .kpi-card .val {
      font-size: 36px;
      font-weight: 800;
      line-height: 1.1;
      font-variant-numeric: tabular-nums;
    }

    .kpi-card .sub {
      font-size: 12px;
      color: #94A3B8;
      margin-top: 4px;
    }

    .kpi-card .val.blue {
      color: #2563EB;
    }

    .kpi-card .val.green {
      color: #059669;
    }

    .kpi-card .val.amber {
      color: #D97706;
    }

    .kpi-card .val.dark {
      color: #1E293B;
    }

    .meter {
      width: 100%;
      height: 6px;
      background: #F1F5F9;
      border-radius: 3px;
      margin-top: 8px;
    }

    .meter-bar {
      height: 100%;
      border-radius: 3px;
      transition: width .5s;
    }

    /* 2-Column Content */
    .ov-content {
      display: grid;
      grid-template-columns: 3fr 2fr;
      gap: 16px;
      height: calc(100% - 180px);
    }

    .ov-left {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .ov-right {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Chart Cards */
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .04);
      border: 1px solid #F1F5F9;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      color: #334155;
      margin-bottom: 12px;
      flex-shrink: 0;
    }

    .chart-wrap {
      flex: 1;
      position: relative;
      min-height: 0;
    }

    .chart-wrap canvas {
      position: absolute;
      inset: 0;
      width: 100% !important;
      height: 100% !important;
    }

    /* Funnel */
    .funnel-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    .funnel-stage {
      border-radius: 10px;
      padding: 16px;
      text-align: center;
      color: #fff;
      position: relative;
    }

    .funnel-stage .fn {
      font-size: 32px;
      font-weight: 800;
      line-height: 1;
    }

    .funnel-stage .fl {
      font-size: 11px;
      font-weight: 500;
      opacity: .9;
      text-transform: uppercase;
      letter-spacing: .5px;
      margin-top: 4px;
    }

    .funnel-stage .fpct {
      font-size: 10px;
      opacity: .7;
      margin-top: 2px;
    }

    /* Insights Grid */
    .ins-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .ins-item {
      padding: 12px 14px;
      background: #F8FAFC;
      border-radius: 8px;
      border: 1px solid #F1F5F9;
    }

    .ins-item .ins-l {
      font-size: 11px;
      color: #94A3B8;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: .3px;
    }

    .ins-item .ins-v {
      font-size: 15px;
      font-weight: 700;
      color: #1E293B;
      margin-top: 2px;
    }

    .tag {
      display: inline-block;
      padding: 3px 8px;
      background: #DBEAFE;
      color: #2563EB;
      border-radius: 4px;
      font-size: 11px;
      margin: 2px;
      font-weight: 500;
    }

    /* ─── TABLE TAB ─── */
    .tbl-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .tbl-bar h3 {
      font-size: 16px;
      font-weight: 600;
    }

    .srch {
      padding: 8px 14px;
      border: 1px solid #E2E8F0;
      border-radius: 8px;
      font-size: 13px;
      width: 240px;
      outline: none;
      font-family: inherit;
    }

    .srch:focus {
      border-color: #2563EB;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, .1);
    }

    .tbl-wrap {
      overflow: auto;
      height: calc(100% - 50px);
      border-radius: 10px;
      border: 1px solid #E2E8F0;
      background: #fff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th {
      text-align: left;
      padding: 10px 14px;
      font-size: 11px;
      color: #64748B;
      text-transform: uppercase;
      letter-spacing: .4px;
      font-weight: 600;
      background: #F8FAFC;
      position: sticky;
      top: 0;
      cursor: pointer;
      border-bottom: 1px solid #E2E8F0;
    }

    th:hover {
      color: #2563EB;
    }

    td {
      padding: 10px 14px;
      border-bottom: 1px solid #F1F5F9;
      font-size: 13px;
    }

    tr:hover td {
      background: #F8FAFC;
    }

    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }

    .bg {
      background: #D1FAE5;
      color: #059669;
    }

    .bb {
      background: #DBEAFE;
      color: #2563EB;
    }

    .ba {
      background: #FEF3C7;
      color: #D97706;
    }

    .br {
      background: #FEE2E2;
      color: #DC2626;
    }

    a.lk {
      color: #2563EB;
      text-decoration: none;
      font-weight: 500;
      font-size: 12px;
    }

    a.lk:hover {
      text-decoration: underline;
    }

    /* ─── LOGS TAB ─── */
    .log-box {
      font-family: 'Cascadia Code', 'Fira Code', 'JetBrains Mono', monospace;
      font-size: 12px;
      line-height: 1.8;
      height: 100%;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #E2E8F0;
      border-radius: 10px;
      padding: 12px 16px;
    }

    .lg {
      padding: 2px 6px;
      border-radius: 3px;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .lg:hover {
      background: #F8FAFC;
    }

    .lg-i {
      color: #64748B;
    }

    .lg-w {
      color: #D97706;
    }

    .lg-e {
      color: #DC2626;
      font-weight: 600;
    }

    /* Controls */
    .ctrl {
      display: flex;
      align-items: center;
      gap: 10px;
      border-top: 1px solid #E2E8F0;
      padding: 10px 32px;
      flex-shrink: 0;
      background: #fff;
    }

    .btn {
      padding: 6px 16px;
      border: 1px solid #E2E8F0;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      background: #fff;
      transition: .15s;
      font-family: inherit;
    }

    .btn:hover {
      border-color: #2563EB;
      color: #2563EB;
      background: #F8FAFC;
    }

    .btn.red {
      border-color: #FCA5A5;
      color: #DC2626;
    }

    .btn.red:hover {
      background: #FEF2F2;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <div class="hdr">
    <div class="hdr-left">
      <h1>Job Search <b>Command Center</b></h1>
      <div class="live-badge" id="live-badge">
        <div class="pulse"></div><span id="live-txt">Connecting</span>
      </div>
    </div>
    <div class="hdr-right">
      <span style="font-size:12px;color:#94A3B8;" id="uptime-txt">Uptime: —</span>
      <span style="font-size:12px;color:#16A34A;font-weight:600;" id="last-act"></span>
      <div class="date-pills">
        <button class="dp on" data-r="today">Today</button>
        <button class="dp" data-r="week">Week</button>
        <button class="dp" data-r="all">All</button>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab on" data-t="overview">Overview</div>
    <div class="tab" data-t="applications">Applications <span class="cnt" id="tc-a">0</span></div>
    <div class="tab" data-t="contacts">Contacts <span class="cnt" id="tc-c">0</span></div>
    <div class="tab" data-t="logs">Logs <span class="cnt" id="tc-l">0</span></div>
  </div>

  <!-- Panes -->
  <div class="main">
    <!-- OVERVIEW -->
    <div class="pane on" id="p-overview">
      <!-- KPI Row -->
      <div class="kpi-row">
        <div class="kpi-card">
          <div class="label">Applications Sent</div>
          <div class="val blue" id="k1">—</div>
          <div class="sub" id="k1s">in selected range</div>
        </div>
        <div class="kpi-card">
          <div class="label">Avg Match Score</div>
          <div class="val green" id="k2">—</div>
          <div class="sub">across applied jobs</div>
        </div>
        <div class="kpi-card">
          <div class="label">Recruiter Messages</div>
          <div class="val amber" id="k3">—</div>
          <div class="sub">auto-sent on Naukri</div>
        </div>
        <div class="kpi-card">
          <div class="label">Cover Letters</div>
          <div class="val blue" id="k4">—</div>
          <div class="sub">for score 70+ jobs</div>
        </div>
        <div class="kpi-card">
          <div class="label">Gemini Free Tier</div>
          <div class="val dark" id="k5" style="font-size:24px;">—</div>
          <div class="meter">
            <div class="meter-bar" id="gm" style="width:0%;background:#059669;"></div>
          </div>
          <div class="sub" id="k5s">calls today</div>
        </div>
      </div>

      <!-- 2-Column -->
      <div class="ov-content">
        <div class="ov-left">
          <div class="card">
            <div class="card-title">Application Volume by Hour</div>
            <div class="chart-wrap"><canvas id="ch1"></canvas></div>
          </div>
          <div class="card">
            <div class="card-title">Score Distribution</div>
            <div class="chart-wrap"><canvas id="ch2"></canvas></div>
          </div>
        </div>
        <div class="ov-right">
          <div class="card" style="flex:0 0 auto;">
            <div class="card-title">Pipeline Funnel</div>
            <div class="funnel-row" id="funnel"></div>
          </div>
          <div class="card" style="flex:1;">
            <div class="card-title">Key Insights</div>
            <div class="ins-grid" id="insights"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- APPLICATIONS -->
    <div class="pane" id="p-applications">
      <div class="tbl-bar">
        <h3>All Applications</h3><input type="text" class="srch" id="srch" placeholder="Search company or role...">
      </div>
      <div class="tbl-wrap">
        <table>
          <thead>
            <tr>
              <th data-s="appliedAt">Time ↕</th>
              <th data-s="company">Company ↕</th>
              <th data-s="title">Role ↕</th>
              <th data-s="matchScore">Score ↕</th>
              <th>Msg</th>
              <th>Status</th>
              <th>Link</th>
            </tr>
          </thead>
          <tbody id="jtb"></tbody>
        </table>
      </div>
    </div>

    <!-- CONTACTS -->
    <div class="pane" id="p-contacts">
      <div class="tbl-bar">
        <h3>Extracted Contacts</h3>
      </div>
      <div class="tbl-wrap" style="height:calc(100% - 40px)">
        <table>
          <thead>
            <tr>
              <th>Company</th>
              <th>Role</th>
              <th>Recruiter</th>
              <th>Email</th>
              <th>LinkedIn</th>
            </tr>
          </thead>
          <tbody id="ctb"></tbody>
        </table>
      </div>
    </div>

    <!-- LOGS -->
    <div class="pane" id="p-logs">
      <div class="log-box" id="lbox"></div>
    </div>
  </div>

  <!-- Controls -->
  <div class="ctrl">
    <button class="btn" onclick="ctl('pause')">⏸ Pause</button>
    <button class="btn" onclick="ctl('resume')">▶ Resume</button>
    <button class="btn red" onclick="ctl('stop')">⛔ Emergency Stop</button>
    <span style="margin-left:auto;font-size:12px;color:#94A3B8;">Searching: </span>
    <span id="role-tags"></span>
  </div>

  <script>
    let R = 'today', logN = 0, c1, c2, allJ = [], sC = 'appliedAt', sD = -1;

    // Tabs
    document.querySelectorAll('.tab').forEach(t => t.onclick = () => {
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('on'));
      document.querySelectorAll('.pane').forEach(x => x.classList.remove('on'));
      t.classList.add('on');
      document.getElementById('p-' + t.dataset.t).classList.add('on');
    });

    // Date
    document.querySelectorAll('.dp').forEach(b => b.onclick = () => {
      document.querySelectorAll('.dp').forEach(x => x.classList.remove('on'));
      b.classList.add('on'); R = b.dataset.r; loadAll();
    });

    // WebSocket
    function ws() {
      const s = new WebSocket(`ws://${location.host}`);
      s.onopen = () => { document.getElementById('live-badge').className = 'live-badge'; document.getElementById('live-txt').textContent = 'Live'; };
      s.onclose = () => { document.getElementById('live-badge').className = 'live-badge off'; document.getElementById('live-txt').textContent = 'Offline'; setTimeout(ws, 3000); };
      s.onmessage = e => { const d = JSON.parse(e.data); if (d.type === 'log') addLog(d); };
    }
    function addLog(e) {
      const el = document.getElementById('lbox'), d = document.createElement('div');
      d.className = `lg ${e.level === 'error' ? 'lg-e' : e.level === 'warn' ? 'lg-w' : 'lg-i'}`;
      const ts = e.timestamp ? (e.timestamp.split(' ')[1] || '') : '';
      d.textContent = `${ts}  ${e.level.toUpperCase().padEnd(5)}  ${e.message}`;
      el.appendChild(d); logN++;
      document.getElementById('tc-l').textContent = logN;
      while (el.children.length > 500) el.removeChild(el.firstChild);
      el.scrollTop = el.scrollHeight;
    }

    async function loadAll() {
      try {
        const [sr, jr, cr] = await Promise.all([fetch(`/api/stats?range=${R}`), fetch(`/api/jobs?range=${R}`), fetch('/api/contacts')]);
        const s = await sr.json(), j = await jr.json(), c = await cr.json();
        renderKPI(s); renderCharts(s); renderFunnel(s.pipeline, s.appliedInRange); renderInsights(s);
        allJ = j; renderJobs(j); renderContacts(c);
        document.getElementById('tc-a').textContent = j.length;
        document.getElementById('tc-c').textContent = c.length;
        // Uptime
        const m = Math.floor(s.uptime / 60), h = Math.floor(m / 60);
        document.getElementById('uptime-txt').textContent = `Uptime: ${h > 0 ? h + 'h ' : ''}${m % 60}m`;
        // Last activity
        const la = document.getElementById('last-act');
        if (s.lastApplyAgo !== null && s.lastApplyAgo !== undefined) {
          la.textContent = s.lastApplyAgo < 1 ? '● Just now' : `● Last apply: ${s.lastApplyAgo}m ago`;
          la.style.color = s.lastApplyAgo < 10 ? '#16A34A' : s.lastApplyAgo < 60 ? '#D97706' : '#94A3B8';
        } else {
          la.textContent = '● Idle';
          la.style.color = '#94A3B8';
        }
      } catch (e) { console.error(e); }
    }

    function renderKPI(s) {
      document.getElementById('k1').textContent = s.appliedInRange;
      document.getElementById('k1s').textContent = R === 'today' ? 'today' : R === 'week' ? 'this week' : 'all time';
      document.getElementById('k2').textContent = s.avgScore > 0 ? s.avgScore + '%' : '—';
      document.getElementById('k3').textContent = s.messagesSent;
      document.getElementById('k4').textContent = s.coverLetters;
      const p = Math.round((s.geminiUsed / s.geminiLimit) * 100);
      document.getElementById('k5').textContent = `${s.geminiUsed} / ${s.geminiLimit}`;
      document.getElementById('k5s').textContent = `${100 - p}% remaining`;
      const m = document.getElementById('gm'); m.style.width = p + '%';
      m.style.background = p > 80 ? '#DC2626' : p > 50 ? '#D97706' : '#059669';
      document.getElementById('role-tags').innerHTML = (s.targetRoles || []).slice(0, 5).map(r => `<span class="tag">${r}</span>`).join('');
    }

    function renderCharts(s) {
      // Volume by hour → Doughnut
      const vL = Object.keys(s.volumeMap).sort(), vD = vL.map(k => s.volumeMap[k]);
      const vColors = vL.map((_, i) => {
        const hues = [210, 220, 200, 230, 190, 240, 180, 250, 170, 260];
        return `hsl(${hues[i % hues.length]}, 70%, ${50 + (i % 3) * 10}%)`;
      });
      if (c1) c1.destroy();
      c1 = new Chart(document.getElementById('ch1'), {
        type: 'doughnut',
        data: { labels: vL, datasets: [{ data: vD, backgroundColor: vColors, borderWidth: 2, borderColor: '#fff', hoverOffset: 8 }] },
        options: {
          responsive: true, maintainAspectRatio: false, cutout: '55%',
          plugins: {
            legend: { position: 'right', labels: { font: { size: 12, family: 'Inter', weight: '500' }, color: '#334155', padding: 10, usePointStyle: true, pointStyle: 'circle' } },
            tooltip: {
              backgroundColor: '#1E293B', titleFont: { size: 13, family: 'Inter' }, bodyFont: { size: 13, family: 'Inter' }, padding: 12, cornerRadius: 8,
              callbacks: { label: ctx => ` ${ctx.label}: ${ctx.parsed} applications` }
            }
          }
        }
      });

      // Score distribution → Doughnut
      const sL = Object.keys(s.scoreDist), sD2 = sL.map(k => s.scoreDist[k]);
      const sColors = ['#EF4444', '#F59E0B', '#3B82F6', '#10B981', '#059669'];
      if (c2) c2.destroy();
      c2 = new Chart(document.getElementById('ch2'), {
        type: 'doughnut',
        data: { labels: sL, datasets: [{ data: sD2, backgroundColor: sColors, borderWidth: 2, borderColor: '#fff', hoverOffset: 8 }] },
        options: {
          responsive: true, maintainAspectRatio: false, cutout: '55%',
          plugins: {
            legend: { position: 'right', labels: { font: { size: 12, family: 'Inter', weight: '500' }, color: '#334155', padding: 10, usePointStyle: true, pointStyle: 'circle' } },
            tooltip: {
              backgroundColor: '#1E293B', titleFont: { size: 13, family: 'Inter' }, bodyFont: { size: 13, family: 'Inter' }, padding: 12, cornerRadius: 8,
              callbacks: { label: ctx => ` Score ${ctx.label}: ${ctx.parsed} jobs` }
            }
          }
        }
      });
    }

    function renderFunnel(p, total) {
      const t = Math.max(total, 1);
      const stages = [
        { l: 'Applied', n: p.applied, c: '#2563EB' }, { l: 'Messaged', n: p.messaged, c: '#7C3AED' },
        { l: 'Interview', n: p.interview, c: '#D97706' }, { l: 'Offer', n: p.offer, c: '#059669' }
      ];
      document.getElementById('funnel').innerHTML = stages.map((s, i) => {
        const pct = i > 0 ? ((s.n / t) * 100).toFixed(1) + '%' : '100%';
        return `<div class="funnel-stage" style="background:${s.c}"><div class="fn">${s.n}</div><div class="fl">${s.l}</div><div class="fpct">${i > 0 ? pct : ''}</div></div>`;
      }).join('');
    }

    function renderInsights(s) {
      const ins = [];
      ins.push({ l: 'Total All-Time', v: s.appliedTotal });
      ins.push({ l: 'Profile Skills', v: s.profileSkills });
      ins.push({ l: 'Contacts Found', v: s.contactsFound });
      ins.push({ l: 'Max Score', v: s.maxScore > 0 ? s.maxScore : '—' });
      if (s.topCompanies && s.topCompanies[0]) ins.push({ l: 'Top Company', v: `${s.topCompanies[0].name} (${s.topCompanies[0].count})` });
      if (s.topRoles && s.topRoles[0]) ins.push({ l: 'Top Role', v: `${s.topRoles[0].name} (${s.topRoles[0].count})` });
      ins.push({ l: 'Premium 70+', v: `${s.coverLetters} jobs` });
      ins.push({ l: 'Apps This Hour', v: s.appliedThisHour || 0 });
      if (s.topRoles && s.topRoles.length > 1) ins.push({ l: '2nd Role', v: `${s.topRoles[1].name} (${s.topRoles[1].count})` });
      // Peak hour
      const vol = s.volumeMap;
      const peak = Object.entries(vol).sort((a, b) => b[1] - a[1])[0];
      if (peak) ins.push({ l: 'Peak Hour', v: `${peak[0]} (${peak[1]} apps)` });
      // Rate
      const upH = s.uptime / 3600;
      if (upH > 0.1) ins.push({ l: 'Apps/Hour', v: Math.round(s.appliedInRange / upH) });
      document.getElementById('insights').innerHTML = ins.map(i =>
        `<div class="ins-item"><div class="ins-l">${i.l}</div><div class="ins-v">${i.v}</div></div>`
      ).join('');
    }

    function renderJobs(jobs) {
      const q = (document.getElementById('srch').value || '').toLowerCase();
      let f = jobs; if (q) f = jobs.filter(j => ((j.company || '') + ' ' + (j.title || '')).toLowerCase().includes(q));
      f.sort((a, b) => { let va = a[sC] || '', vb = b[sC] || ''; if (typeof va === 'number') return (va - vb) * sD; return String(va).localeCompare(String(vb)) * sD; });
      document.getElementById('jtb').innerHTML = f.slice(0, 200).map(j => {
        const t = j.appliedAt ? new Date(j.appliedAt).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }) : '—';
        const sc = j.matchScore || 0;
        const bc = sc >= 70 ? 'bg' : sc >= 50 ? 'bb' : sc >= 40 ? 'ba' : 'br';
        const msg = j.recruiterMessageSent ? '<span class="badge bg">✓ Sent</span>' : '<span style="color:#CBD5E1">—</span>';
        const st = `<span class="badge ${j.status === 'interview' ? 'bg' : 'bb'}">${j.status || 'applied'}</span>`;
        const lnk = j.url ? `<a class="lk" href="${j.url}" target="_blank">Open →</a>` : '—';
        return `<tr><td>${t}</td><td><strong>${j.company || '—'}</strong></td><td>${j.title || '—'}</td><td><span class="badge ${bc}">${sc}</span></td><td>${msg}</td><td>${st}</td><td>${lnk}</td></tr>`;
      }).join('');
    }

    function renderContacts(contacts) {
      document.getElementById('ctb').innerHTML = contacts.slice(0, 50).map(c => {
        const em = (c.emails || []).join(', ') || '<span style="color:#CBD5E1">—</span>';
        const li = (c.linkedinUrls || []).map(u => `<a href="${u}" target="_blank" class="lk">${(u.split('/in/')[1] || '').replace(/\/$/, '') || 'profile'}</a>`).join(', ') || '<span style="color:#CBD5E1">—</span>';
        return `<tr><td><strong>${c.company || '—'}</strong></td><td>${c.jobTitle || '—'}</td><td>${c.recruiterName || '—'}</td><td>${em}</td><td>${li}</td></tr>`;
      }).join('');
    }

    document.querySelectorAll('th[data-s]').forEach(th => th.onclick = () => { const c = th.dataset.s; if (sC === c) sD *= -1; else { sC = c; sD = -1; } renderJobs(allJ); });
    document.getElementById('srch').addEventListener('input', () => renderJobs(allJ));
    async function ctl(a) { if (a === 'stop' && !confirm('Emergency stop?')) return; try { await fetch(`/api/control?action=${a}`) } catch { } }

    ws(); loadAll(); setInterval(loadAll, 8000);
  </script>
</body>

</html>